permissions:
  id-token: write
  contents: read

name: 'Deploy review environment'
on:
  pull_request:

jobs:
  build-base:
    runs-on: ubuntu-latest
    outputs:
      base_client_id: ${{ steps.base_outputs.outputs.base_client_id }}
    steps:
    - uses: actions/checkout@v4
    - uses: pulumi/auth-actions@v1
      with:
        organization: ${{ vars.pulumi_org }}
        scope: ${{ vars.pulumi_scope }}
        requested-token-type: urn:pulumi:token-type:access_token:personal
    - uses: actions/setup-dotnet@v4
      with: 
        dotnet-version: 8.0.x
    - uses: pulumi/actions@v6
      with:
        command: up
        stack-name: base
        work-dir: src/base
      env:
        ARM_USE_OIDC: true
        ARM_CLIENT_ID: ${{ vars.clientId }}
        ARM_TENANT_ID: ${{ vars.tenantId }}
    - name: Save stack outputs
      id: base_outputs
      run: echo "base_client_id=$(pulumi stack output 'mi-shared-review:principalId')" >> "$GITHUB_OUTPUT"
  build-review:
    runs-on: ubuntu-latest
    needs: build-base
    steps:
    - uses: actions/checkout@v4
    - uses: pulumi/auth-actions@v1
      with:
        organization: ${{ vars.pulumi_org }}
        scope: ${{ vars.pulumi_scope }}
        requested-token-type: urn:pulumi:token-type:access_token:personal
    - uses: actions/setup-dotnet@v4
      with: 
        dotnet-version: 8.0.x
    - uses: pulumi/actions@v6
      with:
        command: up
        stack-name: review
        work-dir: src/review
      env:
        ARM_USE_OIDC: true
        ARM_CLIENT_ID: ${{ needs.build-base.outputs.base_client_id }}
        ARM_TENANT_ID: ${{ vars.tenantId }}
